<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Poll App</title>
  <script src="https://www.gstatic.com/firebasejs/7.20.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.20.0/firebase-database.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      padding: 0;
      background-color: #f4f4f9;
    }
    .container {
      max-width: 600px;
      margin: auto;
      padding: 20px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }
    h1 {
      text-align: center;
    }
    .poll {
      margin-bottom: 20px;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #ddd;
    }
    .poll-options label {
      display: block;
      margin-bottom: 8px;
      cursor: pointer;
    }
    .btn {
      display: block;
      margin: 10px auto;
      padding: 10px 20px;
      font-size: 16px;
      color: white;
      background-color: #007BFF;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .btn:hover {
      background-color: #0056b3;
    }
    .progress-container {
      width: 100%;
      background: #f3f3f3;
      margin-top: 20px;
      height: 8px;
      border-radius: 5px;
      display: none;
    }
    .progress-bar {
      height: 100%;
      width: 0;
      background: #4caf50;
      border-radius: 5px;
    }
    .spinner {
      display: none;
      margin: 0 auto;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 2s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container" id="app">
    <h1>Poll App</h1>
    <div id="polls"></div>
    <div class="progress-container" id="progress-container">
      <div class="progress-bar" id="progress-bar"></div>
    </div>
    <div class="spinner" id="spinner"></div>
  </div>

  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBTlvvGGWKaAsOyQ4zSeJ5aID_eD3nMfkI",
      authDomain: "truth-dare-5a92c.firebaseapp.com",
      databaseURL: "https://truth-dare-5a92c-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "truth-dare-5a92c",
      storageBucket: "truth-dare-5a92c.firebasestorage.app",
      messagingSenderId: "299104332770",
      appId: "1:299104332770:web:469c2a277ad01e57efa7bb",
      measurementId: "G-NER090QMCZ"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    const app = document.getElementById("app");
    const pollsDiv = document.getElementById("polls");
    const progressContainer = document.getElementById("progress-container");
    const progressBar = document.getElementById("progress-bar");
    const spinner = document.getElementById("spinner");

    // Load Polls from Firebase
    function loadPolls() {
      database.ref('polls').on('value', (snapshot) => {
        const polls = snapshot.val();
        pollsDiv.innerHTML = ''; // Clear existing polls

        for (let id in polls) {
          const poll = polls[id];
          const pollDiv = document.createElement("div");
          pollDiv.classList.add("poll");
          pollDiv.innerHTML = `
            <h3>${poll.question}</h3>
            <div class="poll-options">
              ${poll.options.map((option, index) => {
                const percentage = calculatePercentage(poll.votes, option);
                return `
                  <label>
                    <input type="radio" name="poll-${id}" value="${option}" ${hasUserVoted(id) ? 'disabled' : ''}>
                    ${option} - ${percentage}% Votes
                  </label>
                `;
              }).join('')}
            </div>
            <button class="btn" onclick="submitPoll('${id}', '${poll.question}')">Submit Answer</button>
          `;
          pollsDiv.appendChild(pollDiv);
        }
      });
    }

    // Calculate percentage of votes for an option
    function calculatePercentage(votes, option) {
      const totalVotes = Object.values(votes || {}).reduce((sum, count) => sum + count, 0);
      const optionVotes = votes ? votes[option] || 0 : 0;
      return totalVotes === 0 ? 0 : Math.round((optionVotes / totalVotes) * 100);
    }

    // Check if user has already voted (cache)
    function hasUserVoted(pollId) {
      const userVote = localStorage.getItem(`poll-${pollId}`);
      return userVote !== null;
    }

    // Submit Poll Answer
    function submitPoll(pollId, question) {
      const selectedOption = document.querySelector(`input[name="poll-${pollId}"]:checked`);
      if (!selectedOption) {
        alert("Please select an option.");
        return;
      }

      const answer = selectedOption.value;
      const userVote = localStorage.getItem(`poll-${pollId}`);

      // Prevent re-voting
      if (userVote) {
        alert("You've already voted on this poll.");
        return;
      }

      // Show progress
      spinner.style.display = "block";
      progressContainer.style.display = "block";
      let progress = 0;
      const interval = setInterval(() => {
        progress += 10;
        progressBar.style.width = `${progress}%`;
        if (progress >= 100) {
          clearInterval(interval);
        }
      }, 500);

      // Save user's response to Firebase
      const pollRef = database.ref(`polls/${pollId}`);
      pollRef.once('value', (snapshot) => {
        const poll = snapshot.val();
        const updatedVotes = { ...poll.votes };
        updatedVotes[answer] = (updatedVotes[answer] || 0) + 1;

        pollRef.update({ votes: updatedVotes })
          .then(() => {
            // Save response in localStorage to prevent re-voting
            localStorage.setItem(`poll-${pollId}`, answer);
            spinner.style.display = "none";
            progressContainer.style.display = "none";
            alert("Your response has been recorded!");
          })
          .catch((error) => {
            spinner.style.display = "none";
            progressContainer.style.display = "none";
            console.error("Error saving poll response: ", error);
            alert("An error occurred while saving your response. Please try again.");
          });
      });
    }

    loadPolls();
  </script>
</body>
</html>
